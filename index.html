<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花札 - こいこい</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        .card {
            width: 80px;
            height: 120px;
            border: 1px solid #000;
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }
        .card:hover {
            border: 2px solid #00f;
        }
        #field, #player-hand, #deck, #player-collected, #ai-hand, #ai-collected, #message, #player-score-details, #ai-score-details {
            margin: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .matched {
            border: 2px solid green;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            display: none;
            cursor: pointer;
        }
        #koi-button.active, #end-button.active, #restart-button.active {
            display: inline-block;
        }
        #player-score-details, #ai-score-details {
            font-size: 14px;
        }
        h1 {
            text-align: center;
            font-size: 24px;
        }
        #message {
            text-align: center;
            font-size: 18px;
            padding: 10px;
            white-space: pre-wrap;
        }
        .selectable {
            border: 2px dashed #ff0;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .card {
                width: 50px;
                height: 75px;
                margin: 2px;
            }
            h1 {
                font-size: 20px;
            }
            #message {
                font-size: 14px;
            }
            button {
                padding: 8px 16px;
                font-size: 14px;
            }
            #field, #player-hand, #deck, #player-collected, #ai-hand, #ai-collected, #player-score-details, #ai-score-details {
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <h1>花札 - こいこい</h1>
    <div id="deck">山札: <span id="deck-count"></span></div>
    <div id="field">場:</div>
    <div id="player-hand">プレイヤーの手札:</div>
    <div id="player-collected">プレイヤーの獲得札:</div>
    <div id="player-score-details">プレイヤーの得点: <span id="player-points">0</span>点</div>
    <div id="ai-hand">AIの残り手札: <span id="ai-hand-count">0</span></div>
    <div id="ai-collected">AIの獲得札:</div>
    <div id="ai-score-details">AIの得点: <span id="ai-points">0</span>点</div>
    <div id="message">ゲーム開始！プレイヤーの手番です。</div>
    <button id="koi-button" onclick="callKoi()">こいこい</button>
    <button id="end-button" onclick="endTurn()">上がり</button>
    <button id="restart-button" onclick="initGame()">もう一度遊ぶ</button>

    <script>
        const hanafudaCards = [
            { month: "1月", type: "松", value: 20, name: "松の光", image: "images/january_hikari.png" },
            { month: "1月", type: "松", value: 5, name: "松の短", image: "images/january_tan.png" },
            { month: "1月", type: "松", value: 1, name: "松のカス1", image: "images/january_kasu1.png" },
            { month: "1月", type: "松", value: 1, name: "松のカス2", image: "images/january_kasu2.png" },
            { month: "2月", type: "梅", value: 10, name: "梅の種", image: "images/february_tane.png" },
            { month: "2月", type: "梅", value: 5, name: "梅の短", image: "images/february_tan.png" },
            { month: "2月", type: "梅", value: 1, name: "梅のカス1", image: "images/february_kasu1.png" },
            { month: "2月", type: "梅", value: 1, name: "梅のカス2", image: "images/february_kasu2.png" },
            { month: "3月", type: "桜", value: 20, name: "桜の光", image: "images/march_hikari.png" },
            { month: "3月", type: "桜", value: 5, name: "桜の短", image: "images/march_tan.png" },
            { month: "3月", type: "桜", value: 1, name: "桜のカス1", image: "images/march_kasu1.png" },
            { month: "3月", type: "桜", value: 1, name: "桜のカス2", image: "images/march_kasu2.png" },
            { month: "4月", type: "藤", value: 10, name: "藤の種", image: "images/april_tane.png" },
            { month: "4月", type: "藤", value: 5, name: "藤の短", image: "images/april_tan.png" },
            { month: "4月", type: "藤", value: 1, name: "藤のカス1", image: "images/april_kasu1.png" },
            { month: "4月", type: "藤", value: 1, name: "藤のカス2", image: "images/april_kasu2.png" },
            { month: "5月", type: "菖蒲", value: 10, name: "菖蒲の種", image: "images/may_tane.png" },
            { month: "5月", type: "菖蒲", value: 5, name: "菖蒲の短", image: "images/may_tan.png" },
            { month: "5月", type: "菖蒲", value: 1, name: "菖蒲のカス1", image: "images/may_kasu1.png" },
            { month: "5月", type: "菖蒲", value: 1, name: "菖蒲のカス2", image: "images/may_kasu2.png" },
            { month: "6月", type: "牡丹", value: 10, name: "牡丹の種", image: "images/june_tane.png" },
            { month: "6月", type: "牡丹", value: 5, name: "牡丹の短", image: "images/june_tan.png" },
            { month: "6月", type: "牡丹", value: 1, name: "牡丹のカス1", image: "images/june_kasu1.png" },
            { month: "6月", type: "牡丹", value: 1, name: "牡丹のカス2", image: "images/june_kasu2.png" },
            { month: "7月", type: "萩", value: 10, name: "萩の種", image: "images/july_tane.png" },
            { month: "7月", type: "萩", value: 5, name: "萩の短", image: "images/july_tan.png" },
            { month: "7月", type: "萩", value: 1, name: "萩のカス1", image: "images/july_kasu1.png" },
            { month: "7月", type: "萩", value: 1, name: "萩のカス2", image: "images/july_kasu2.png" },
            { month: "8月", type: "芒", value: 20, name: "芒の光", image: "images/august_hikari.png" },
            { month: "8月", type: "芒", value: 10, name: "芒の種", image: "images/august_tane.png" },
            { month: "8月", type: "芒", value: 1, name: "芒のカス1", image: "images/august_kasu1.png" },
            { month: "8月", type: "芒", value: 1, name: "芒のカス2", image: "images/august_kasu2.png" },
            { month: "9月", type: "菊", value: 10, name: "菊の種", image: "images/september_tane.png" },
            { month: "9月", type: "菊", value: 5, name: "菊の短", image: "images/september_tan.png" },
            { month: "9月", type: "菊", value: 1, name: "菊のカス1", image: "images/september_kasu1.png" },
            { month: "9月", type: "菊", value: 1, name: "菊のカス2", image: "images/september_kasu2.png" },
            { month: "10月", type: "紅葉", value: 10, name: "紅葉の種", image: "images/october_tane.png" },
            { month: "10月", type: "紅葉", value: 5, name: "紅葉の短", image: "images/october_tan.png" },
            { month: "10月", type: "紅葉", value: 1, name: "紅葉のカス1", image: "images/october_kasu1.png" },
            { month: "10月", type: "紅葉", value: 1, name: "紅葉のカス2", image: "images/october_kasu2.png" },
            { month: "11月", type: "柳", value: 20, name: "柳の光", image: "images/november_hikari.png" },
            { month: "11月", type: "柳", value: 10, name: "柳の種", image: "images/november_tane.png" },
            { month: "11月", type: "柳", value: 5, name: "柳の短", image: "images/november_tan.png" },
            { month: "11月", type: "柳", value: 1, name: "柳のカス", image: "images/november_kasu.png" },
            { month: "12月", type: "桐", value: 20, name: "桐の光", image: "images/december_hikari.png" },
            { month: "12月", type: "桐", value: 1, name: "桐のカス1", image: "images/december_kasu1.png" },
            { month: "12月", type: "桐", value: 1, name: "桐のカス2", image: "images/december_kasu2.png" },
            { month: "12月", type: "桐", value: 1, name: "桐のカス3", image: "images/december_kasu3.png" },
        ];

        let deck = [...hanafudaCards];
        let field = [];
        let playerHand = [];
        let aiHand = [];
        let playerCollected = [];
        let aiCollected = [];
        let playerScore = 0;
        let aiScore = 0;
        let playerMultiplier = 1;
        let aiMultiplier = 1;
        let isPlayerTurn = true;
        let isGameOver = false;

        function initGame() {
            deck = shuffle([...hanafudaCards]);
            field = deck.splice(0, 8);
            playerHand = deck.splice(0, 8);
            aiHand = deck.splice(0, 8);
            playerCollected = [];
            aiCollected = [];
            playerScore = 0;
            aiScore = 0;
            playerMultiplier = 1;
            aiMultiplier = 1;
            isPlayerTurn = true;
            isGameOver = false;
            document.getElementById("restart-button").classList.remove("active");
            renderGame();
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderGame() {
            document.getElementById("deck-count").textContent = deck.length;
            const fieldDiv = document.getElementById("field");
            const handDiv = document.getElementById("player-hand");
            const playerCollectedDiv = document.getElementById("player-collected");
            const aiCollectedDiv = document.getElementById("ai-collected");
            const aiHandCount = document.getElementById("ai-hand-count");
            const messageDiv = document.getElementById("message");
            const koiButton = document.getElementById("koi-button");
            const endButton = document.getElementById("end-button");

            fieldDiv.innerHTML = "場: ";
            field.forEach((card, index) => {
                const cardElement = document.createElement("div");
                cardElement.className = "card";
                cardElement.style.backgroundImage = `url(${card.image})`;
                cardElement.dataset.index = index;
                fieldDiv.appendChild(cardElement);
            });

            handDiv.innerHTML = "プレイヤーの手札: ";
            playerHand.forEach((card, index) => {
                const cardElement = document.createElement("div");
                cardElement.className = "card";
                cardElement.style.backgroundImage = `url(${card.image})`;
                if (isPlayerTurn && !isGameOver) cardElement.onclick = () => playCard(index);
                handDiv.appendChild(cardElement);
            });

            playerCollectedDiv.innerHTML = "プレイヤーの獲得札: ";
            playerCollected.forEach(card => {
                const cardElement = document.createElement("div");
                cardElement.className = "card";
                cardElement.style.backgroundImage = `url(${card.image})`;
                playerCollectedDiv.appendChild(cardElement);
            });

            aiHandCount.textContent = aiHand.length;

            aiCollectedDiv.innerHTML = "AIの獲得札: ";
            aiCollected.forEach(card => {
                const cardElement = document.createElement("div");
                cardElement.className = "card";
                cardElement.style.backgroundImage = isGameOver ? `url(${card.image})` : `url(images/back.png)`;
                aiCollectedDiv.appendChild(cardElement);
            });

            const [playerPoints, playerDetails] = calculateScore(playerCollected);
            document.getElementById("player-score-details").innerHTML = `プレイヤーの得点: ${playerPoints * playerMultiplier}点<br>${playerDetails.join("<br>")}`;
            const [aiPoints, aiDetails] = calculateScore(aiCollected);
            document.getElementById("ai-score-details").innerHTML = `AIの得点: ${aiPoints * aiMultiplier}点${isGameOver ? "<br>" + aiDetails.join("<br>") : ""}`;

            if (!isGameOver) {
                messageDiv.textContent = isPlayerTurn ? "プレイヤーの手番です。" : "AIの手番です。";
            }

            if (isGameOver) {
                koiButton.classList.remove("active");
                endButton.classList.remove("active");
            }
        }

        function playCard(index) {
            if (!isPlayerTurn || isGameOver) return;
            const playedCard = playerHand.splice(index, 1)[0];
            const matchedIndices = field.reduce((acc, card, i) => {
                if (card.month === playedCard.month) acc.push(i);
                return acc;
            }, []);

            if (matchedIndices.length === 1) {
                playerCollected.push(playedCard, field.splice(matchedIndices[0], 1)[0]);
                renderGame();
                setTimeout(() => drawFromDeck("player"), 500);
            } else if (matchedIndices.length > 1) {
                showSelection(playedCard, matchedIndices, "player");
            } else {
                field.push(playedCard);
                renderGame();
                setTimeout(() => drawFromDeck("player"), 500); // 場に捨てた後、山札を引く
            }
        }

        function drawFromDeck(player) {
            if (deck.length === 0) {
                endTurnOrGame(player);
                return;
            }
            const drawnCard = deck.pop();
            const matchedIndices = field.reduce((acc, card, i) => {
                if (card.month === drawnCard.month) acc.push(i);
                return acc;
            }, []);

            if (matchedIndices.length === 1) {
                if (player === "player") {
                    playerCollected.push(drawnCard, field.splice(matchedIndices[0], 1)[0]);
                } else {
                    aiCollected.push(drawnCard, field.splice(matchedIndices[0], 1)[0]);
                }
                renderGame();
                endTurnOrGame(player);
            } else if (matchedIndices.length > 1) {
                if (player === "player") {
                    showSelection(drawnCard, matchedIndices, "player");
                } else {
                    const bestIndex = aiChooseBestCard(drawnCard, matchedIndices);
                    aiCollected.push(drawnCard, field.splice(bestIndex, 1)[0]);
                    renderGame();
                    endTurnOrGame("ai");
                }
            } else {
                field.push(drawnCard);
                renderGame();
                endTurnOrGame(player);
            }
        }

        function showSelection(card, matchedIndices, player) {
            const fieldDiv = document.getElementById("field");
            const messageDiv = document.getElementById("message");
            messageDiv.textContent = "場から取るカードを選んでください。";

            matchedIndices.forEach(index => {
                const cardElement = fieldDiv.querySelector(`.card[data-index="${index}"]`);
                if (cardElement) {
                    cardElement.classList.add("selectable");
                    cardElement.onclick = () => selectCard(card, index, player);
                }
            });
        }

        function selectCard(card, selectedIndex, player) {
            if (player === "player") {
                playerCollected.push(card, field.splice(selectedIndex, 1)[0]);
            } else {
                aiCollected.push(card, field.splice(selectedIndex, 1)[0]);
            }
            const fieldDiv = document.getElementById("field");
            const allCards = fieldDiv.querySelectorAll(".card");
            allCards.forEach(cardElement => {
                cardElement.classList.remove("selectable");
                cardElement.onclick = null;
            });
            renderGame();
            if (player === "player") {
                setTimeout(() => drawFromDeck("player"), 500);
            } else {
                endTurnOrGame("ai");
            }
        }

        function aiChooseBestCard(drawnCard, matchedIndices) {
            const candidates = matchedIndices.map(index => field[index]);
            let bestIndex = matchedIndices[0];
            let bestScore = 0;

            candidates.forEach((card, i) => {
                const tempCollected = [...aiCollected, drawnCard, card];
                const [score] = calculateScore(tempCollected);
                const cardValue = card.value;

                if (score > bestScore || (score === bestScore && cardValue > candidates[bestIndex].value)) {
                    bestScore = score;
                    bestIndex = matchedIndices[i];
                }
            });

            return bestIndex;
        }

        function endTurnOrGame(player) {
            const collected = player === "player" ? playerCollected : aiCollected;
            const currentScore = player === "player" ? playerScore : aiScore;
            const multiplier = player === "player" ? playerMultiplier : aiMultiplier;
            const [newPoints] = calculateScore(collected);

            if (newPoints > currentScore && (player === "player" ? playerHand.length : aiHand.length) > 0) {
                if (player === "player") {
                    playerScore = newPoints;
                    showOptions();
                } else {
                    aiScore = newPoints;
                    if (Math.random() > 0.5) {
                        aiMultiplier *= 2;
                        document.getElementById("message").textContent = "AIが「こいこい」を宣言しました！";
                        setTimeout(() => switchTurn(player), 1000);
                    } else {
                        endGame();
                    }
                }
            } else {
                switchTurn(player);
            }
        }

        function switchTurn(player) {
            if (playerHand.length === 0 || aiHand.length === 0) {
                endGame();
                return;
            }
            isPlayerTurn = player === "player" ? false : true;
            renderGame();
            if (!isPlayerTurn) {
                setTimeout(aiTurn, 1000);
            }
        }

        function aiTurn() {
            if (aiHand.length === 0) {
                endGame();
                return;
            }
            const aiCard = aiHand.shift();
            const matchedIndices = field.reduce((acc, card, i) => {
                if (card.month === aiCard.month) acc.push(i);
                return acc;
            }, []);

            if (matchedIndices.length === 1) {
                aiCollected.push(aiCard, field.splice(matchedIndices[0], 1)[0]);
                renderGame();
                setTimeout(() => drawFromDeck("ai"), 500);
            } else if (matchedIndices.length > 1) {
                const bestIndex = aiChooseBestCard(aiCard, matchedIndices);
                aiCollected.push(aiCard, field.splice(bestIndex, 1)[0]);
                renderGame();
                setTimeout(() => drawFromDeck("ai"), 500);
            } else {
                field.push(aiCard);
                renderGame();
                setTimeout(() => drawFromDeck("ai"), 500);
            }
        }

        function calculateScore(collected) {
            let points = 0;
            const details = [];
            const brights = collected.filter(card => card.value === 20);
            const animals = collected.filter(card => card.value === 5);
            const ribbons = collected.filter(card => card.value === 10);
            const chaff = collected.filter(card => card.value === 1);

            if (brights.length === 5) {
                points += 15;
                details.push("五光: 15点");
            } else if (brights.length === 4) {
                const hasRain = brights.some(card => card.name === "柳の光");
                points += hasRain ? 8 : 10;
                details.push(hasRain ? "雨入り四光: 8点" : "四光: 10点");
            } else if (brights.length === 3 && !brights.some(card => card.name === "柳の光")) {
                points += 5;
                details.push("三光: 5点");
            }

            if (animals.length >= 5) {
                const extraPoints = animals.length - 4;
                points += extraPoints;
                details.push(`種札${animals.length}枚: ${extraPoints}点`);
            }
            const ino = collected.some(card => card.name === "萩の種");
            const shika = collected.some(card => card.name === "紅葉の種");
            const cho = collected.some(card => card.name === "牡丹の種");
            if (ino && shika && cho) {
                points += 5;
                details.push("猪鹿蝶: 5点");
            }

            if (ribbons.length >= 5) {
                const extraPoints = ribbons.length - 4;
                points += extraPoints;
                details.push(`短冊${ribbons.length}枚: ${extraPoints}点`);
            }

            if (chaff.length >= 10) {
                const extraPoints = chaff.length - 9;
                points += extraPoints;
                details.push(`カス${chaff.length}枚: ${extraPoints}点`);
            }

            const hanami = collected.some(card => card.name === "桜の光") && 
                          collected.some(card => card.name === "菊の種");
            if (hanami) {
                points += 5;
                details.push("花見で一杯: 5点");
            }

            const tsukimi = collected.some(card => card.name === "芒の光") && 
                           collected.some(card => card.name === "菊の種");
            if (tsukimi) {
                points += 5;
                details.push("月見で一杯: 5点");
            }

            const akaTan1 = collected.some(card => card.name === "松の短");
            const akaTan2 = collected.some(card => card.name === "梅の短");
            const akaTan3 = collected.some(card => card.name === "桜の短");
            if (akaTan1 && akaTan2 && akaTan3) {
                points += 5;
                details.push("赤短三光: 5点");
            }

            const aoTan1 = collected.some(card => card.name === "菖蒲の短");
            const aoTan2 = collected.some(card => card.name === "菊の短");
            const aoTan3 = collected.some(card => card.name === "紅葉の短");
            if (aoTan1 && aoTan2 && aoTan3) {
                points += 5;
                details.push("青短三光: 5点");
            }

            if (details.length === 0) details.push("役なし: 0点");
            return [points, details];
        }

        function showOptions() {
            document.getElementById("koi-button").classList.add("active");
            document.getElementById("end-button").classList.add("active");
            document.getElementById("message").textContent = "役が成立しました！「こいこい」か「上がり」を選んでください。";
        }

        function callKoi() {
            playerMultiplier *= 2;
            document.getElementById("message").textContent = "「こいこい」を宣言しました！";
            switchTurn("player");
        }

        function endTurn() {
            endGame();
        }

        function endGame() {
            isGameOver = true;
            const [playerPoints] = calculateScore(playerCollected);
            const playerTotal = playerPoints * playerMultiplier;
            const [aiPoints] = calculateScore(aiCollected);
            const aiTotal = aiPoints * aiMultiplier;
            const result = playerTotal > aiTotal ? "プレイヤーの勝利！" : 
                          playerTotal < aiTotal ? "AIの勝利！" : "引き分け！";
            document.getElementById("message").textContent = 
                `ゲーム終了！\nプレイヤー: ${playerTotal}点\nAI: ${aiTotal}点\n${result}`;
            renderGame();
            document.getElementById("restart-button").classList.add("active");
        }

        initGame();
    </script>
</body>
</html>